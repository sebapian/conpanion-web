# üìã Approvals Feature Implementation Plan

## üéØ Task Status Tracker

- ‚úÖ Done
- üöß In Progress
- ‚è≥ Pending
- üîÑ Needs Review
- ‚ùå Blocked

---

## üìñ Overview

This feature will add a new "Approvals" tab to the burger menu with two main sections:

1. **Pending Approvals** - Items requiring approval from the current user (as approver)
2. **My Requests** - Items the current user has requested approval for (as requester)

Users can view, approve, decline, or request revisions for different entity types (site_diary, form, entries, tasks). The implementation will start with Site Diaries and expand to other entity types.

---

## üóÑÔ∏è Phase 1: Database Schema Updates

### ‚è≥ 1.1 Create Approval Comments Table

**Migration:** `create_approval_comments_table.sql`

```sql
-- Create approval_comments table for approval-related discussions
CREATE TABLE public.approval_comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  approval_id BIGINT NOT NULL REFERENCES public.approvals(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  comment TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE public.approval_comments ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view comments for approvals they're involved in"
ON public.approval_comments FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM public.approvals a
    LEFT JOIN public.approval_approvers aa ON a.id = aa.approval_id
    WHERE a.id = approval_id
    AND (a.requester_id = auth.uid() OR aa.approver_id = auth.uid())
  )
);

CREATE POLICY "Users can insert comments for approvals they're involved in"
ON public.approval_comments FOR INSERT
WITH CHECK (
  user_id = auth.uid() AND
  EXISTS (
    SELECT 1 FROM public.approvals a
    LEFT JOIN public.approval_approvers aa ON a.id = aa.approval_id
    WHERE a.id = approval_id
    AND (a.requester_id = auth.uid() OR aa.approver_id = auth.uid())
  )
);
```

### ‚è≥ 1.2 Add Comment Support to Approval Actions

**Migration:** `add_approval_action_tracking.sql`

```sql
-- Add action_comment column to approvals table for decline/revision reasons
ALTER TABLE public.approvals
ADD COLUMN action_comment TEXT,
ADD COLUMN action_taken_by UUID REFERENCES auth.users(id),
ADD COLUMN action_taken_at TIMESTAMP WITH TIME ZONE;
```

### ‚è≥ 1.3 Update Approval Logic for Multiple Approvers

**Migration:** `update_approval_multiple_approvers.sql`

```sql
-- Add individual approver status tracking
CREATE TABLE public.approval_approver_responses (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  approval_id BIGINT NOT NULL REFERENCES public.approvals(id) ON DELETE CASCADE,
  approver_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  status approval_status NOT NULL DEFAULT 'submitted',
  comment TEXT,
  responded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(approval_id, approver_id)
);

-- Enable RLS
ALTER TABLE public.approval_approver_responses ENABLE ROW LEVEL SECURITY;

-- Create policies for approver responses
CREATE POLICY "Approvers can view their own responses"
ON public.approval_approver_responses FOR SELECT
USING (approver_id = auth.uid());

CREATE POLICY "Approvers can insert their own responses"
ON public.approval_approver_responses FOR INSERT
WITH CHECK (approver_id = auth.uid());

CREATE POLICY "Approvers can update their own responses"
ON public.approval_approver_responses FOR UPDATE
USING (approver_id = auth.uid());

-- Function to calculate overall approval status based on individual responses
CREATE OR REPLACE FUNCTION calculate_approval_status(approval_id_param BIGINT)
RETURNS approval_status AS $$
DECLARE
  total_approvers INTEGER;
  approved_count INTEGER;
  declined_count INTEGER;
  revision_count INTEGER;
BEGIN
  -- Count total approvers
  SELECT COUNT(*) INTO total_approvers
  FROM approval_approvers aa
  WHERE aa.approval_id = approval_id_param;

  -- Count responses by status
  SELECT
    COUNT(CASE WHEN aar.status = 'approved' THEN 1 END),
    COUNT(CASE WHEN aar.status = 'declined' THEN 1 END),
    COUNT(CASE WHEN aar.status = 'revision_requested' THEN 1 END)
  INTO approved_count, declined_count, revision_count
  FROM approval_approver_responses aar
  WHERE aar.approval_id = approval_id_param;

  -- If any approver declined or requested revision, overall status reflects that
  IF declined_count > 0 THEN
    RETURN 'declined';
  ELSIF revision_count > 0 THEN
    RETURN 'revision_requested';
  ELSIF approved_count = total_approvers THEN
    RETURN 'approved';
  ELSE
    RETURN 'submitted';
  END IF;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-update approval status when approver responds
CREATE OR REPLACE FUNCTION update_approval_status_on_response()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE approvals
  SET
    status = calculate_approval_status(NEW.approval_id),
    last_updated = NOW()
  WHERE id = NEW.approval_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER approval_status_update_trigger
  AFTER INSERT OR UPDATE ON approval_approver_responses
  FOR EACH ROW
  EXECUTE FUNCTION update_approval_status_on_response();
```

---

## üîß Phase 2: API Layer Enhancements

### ‚è≥ 2.1 Generate Updated Database Types

**Command:** Run after database migrations are complete

```bash
npm run types:db
```

This will automatically generate TypeScript types for the new tables and columns in `lib/supabase/types.generated.d.ts`.

### ‚è≥ 2.2 Extend Approvals API (`lib/api/approvals.ts`)

#### New Functions to Add:

```typescript
// Get pending approvals for current user (as approver)
export async function getPendingApprovalsForUser(): Promise<ApprovalWithDetails[]>;

// Get approval requests made by current user (as requester)
export async function getMyApprovalRequests(): Promise<ApprovalWithDetails[]>;

// Get approval details with entity information
export async function getApprovalWithEntityDetails(
  approvalId: number,
): Promise<ApprovalWithEntityDetails>;

// Add comment to approval
export async function addApprovalComment(
  approvalId: number,
  comment: string,
): Promise<ApprovalComment>;

// Get comments for approval
export async function getApprovalComments(approvalId: number): Promise<ApprovalComment[]>;

// Individual approver response (for multiple approver workflow)
export async function submitApproverResponse(
  approvalId: number,
  action: 'approved' | 'declined' | 'revision_requested',
  comment?: string,
): Promise<ApprovalApproverResponse>;

// Get approver responses for an approval
export async function getApproverResponses(approvalId: number): Promise<ApprovalApproverResponse[]>;

// Check if current user can approve (is an approver and hasn't responded yet)
export async function canUserApprove(approvalId: number): Promise<boolean>;
```

#### New Types to Add:

**Note:** After running `npm run types:db`, use the generated types from `lib/supabase/types.generated.d.ts` for database tables. The interfaces below are for enhanced API responses that combine multiple tables.

```typescript
// Use generated types from database
type ApprovalComment = Database['public']['Tables']['approval_comments']['Row'];
type ApprovalApproverResponse = Database['public']['Tables']['approval_approver_responses']['Row'];

// Enhanced interfaces for API responses
interface ApprovalWithDetails {
  id: number;
  status: ApprovalStatus;
  created_at: string;
  entity_type: EntityType;
  entity_id: number;
  requester_name: string;
  entity_title: string; // Dynamic based on entity type
  entity_summary: string; // Brief description
  last_updated: string;
}

interface ApprovalWithEntityDetails extends ApprovalWithDetails {
  entity_data: SiteDiary | FormEntry | Task | Form; // Union type
  comments: ApprovalComment[];
  approvers: ApprovalApprover[];
  approver_responses: ApprovalApproverResponse[];
}

interface ApprovalCommentWithUser extends ApprovalComment {
  user_name: string;
}

interface ApprovalApproverResponseWithUser extends ApprovalApproverResponse {
  approver_name: string;
}
```

### ‚è≥ 2.3 Create Entity-Specific Data Fetchers

**File:** `lib/api/approval-entities.ts`

```typescript
// Unified interface for fetching entity details for approvals
export async function getEntityDetailsForApproval(
  entityType: EntityType,
  entityId: number,
): Promise<EntityDetails>;

// Get entity title for display in lists
export async function getEntityTitle(entityType: EntityType, entityId: number): Promise<string>;
```

---

## üé® Phase 3: UI Components Development

### ‚è≥ 3.1 Core Approval Components

#### `components/approvals/ApprovalsContainer.tsx`

- **Purpose:** Main container with tabs for "Pending Approvals" and "My Requests"
- **Features:**
  - Tab navigation between pending and requests
  - Shared filtering and search functionality
  - Responsive design for mobile/desktop

#### `components/approvals/ApprovalsList.tsx`

- **Purpose:** Reusable list component for both pending and requests
- **Features:**
  - Filter by entity type (All, Site Diaries, Forms, Entries, Tasks)
  - Filter by requester name
  - Date range filtering
  - Status badges with color coding
  - Entity type icons
  - Quick preview of entity title
  - Search functionality

#### `components/approvals/ApprovalCard.tsx`

- **Purpose:** Individual approval item in the list
- **Features:**
  - Entity type badge
  - Status indicator
  - Requester information
  - Entity title and preview
  - Time since requested
  - Click to open detail view

#### ‚è≥ 3.2 Detail View Components

#### `components/approvals/ApprovalDetailDrawer.tsx`

- **Purpose:** Main container for approval detail view
- **Features:**
  - Reuse existing entity detail components
  - Approval-specific actions section
  - Comments section
  - Approval history

#### `components/approvals/ApprovalActions.tsx`

- **Purpose:** Action buttons for approve/decline/request revision
- **Features:**
  - Three action buttons with appropriate styling
  - Comment input for decline/revision actions
  - Confirmation dialogs
  - Loading states
  - Show other approvers' responses
  - Disable actions if user already responded

#### `components/approvals/ApprovalComments.tsx`

- **Purpose:** Comments section for approval discussions
- **Features:**
  - List of existing comments
  - Add new comment form
  - User avatars and timestamps
  - Real-time updates (future enhancement)

### ‚è≥ 3.3 Entity Detail Component Reuse

#### Reusable Components Identified:

1. **Site Diaries:** `app/protected/site-diaries/view-site-diary.tsx`
   - Extract core viewing logic into `components/site-diaries/SiteDiaryViewer.tsx`
   - Remove edit functionality for approval context
2. **Form Entries:** Logic from `app/protected/entries/page.tsx`
   - Extract entry detail view into `components/entries/EntryViewer.tsx`
   - Reuse form rendering components
3. **Tasks:** `app/protected/tasks/[id]/page.tsx`

   - Extract read-only task view into `components/tasks/TaskViewer.tsx`
   - Remove edit capabilities for approval context

4. **Forms:** Reuse existing form display components
   - Use form preview components for approval context

---

## üì± Phase 4: Navigation & Routing

### ‚è≥ 4.1 Update Sidebar Navigation

**File:** `app/components/layout/Sidebar.tsx`

```typescript
// Add Approvals to navItems array
{ name: 'Approvals', icon: CheckCircle2, href: '/protected/approvals' }
```

### ‚è≥ 4.2 Create Approvals Page

**File:** `app/protected/approvals/page.tsx`

- Main approvals dashboard with tabs
- Integration with ApprovalsContainer component
- Responsive design for mobile/desktop
- Start with Site Diaries implementation

### ‚è≥ 4.3 Create Approval Detail Route

**File:** `app/protected/approvals/[id]/page.tsx`

- Individual approval detail page
- Deep linking support
- Back navigation to approvals list

---

## üîÑ Phase 5: Integration with Existing Entity Views

### ‚è≥ 5.1 Update Existing Approval Status Components

- Enhance `components/approval-status-accordian.tsx` to link to new approvals page
- Add "View in Approvals" links where appropriate

### ‚è≥ 5.2 Cross-Navigation

- Add links from entity detail views to approval details
- Breadcrumb navigation for better UX

---

## üìã Phase 6: State Management & Data Flow

### ‚è≥ 6.1 Create Approval Context

**File:** `contexts/ApprovalsContext.tsx`

```typescript
// Manage approval state across components
// Handle real-time updates (future)
// Cache approval data
```

### ‚è≥ 6.2 Custom Hooks

**File:** `hooks/useApprovals.ts`

```typescript
// Hook for fetching and managing approvals
export function usePendingApprovals();
export function useMyApprovalRequests();
export function useApprovalDetail(approvalId: number);
export function useApprovalComments(approvalId: number);
export function useApproverResponses(approvalId: number);
```

---

## üéØ Phase 7: User Experience Enhancements

### ‚è≥ 7.1 Responsive Design

- Desktop-first approach using Tailwind with mobile adaptation via flexbox
- Tab navigation works on both mobile and desktop
- Responsive approval cards and detail views

### ‚è≥ 7.2 Loading States & Error Handling

- Skeleton components for loading states
- Error boundaries for graceful error handling
- Retry mechanisms for failed requests

### ‚è≥ 7.3 Accessibility

- Proper ARIA labels
- Keyboard navigation support
- Screen reader compatibility

---

## üß™ Phase 8: Testing & Validation

### ‚è≥ 8.1 Component Testing

- Unit tests for approval components
- Integration tests for approval workflows
- Mock data for testing scenarios

### ‚è≥ 8.2 User Acceptance Testing

- Test Site Diaries approval workflow first
- Test multiple approver scenarios (1 approver vs multiple approvers)
- Validate permissions and security (including project admin access)
- Test status transitions (resubmission after decline, etc.)
- Cross-browser compatibility

---

## üöÄ Phase 9: Performance & Optimization

### ‚è≥ 9.1 Data Optimization

- Implement pagination for large approval lists
- Optimize database queries
- Add database indexes for approval queries

### ‚è≥ 9.2 Caching Strategy

- Cache approval lists
- Invalidate cache on approval actions
- Implement optimistic updates

---

## üîÆ Future Enhancements (Post-MVP)

### ‚è≥ 10.1 Real-time Updates

- WebSocket integration for live approval updates
- Push notifications for approval requests

### ‚è≥ 10.2 Advanced Features

- Bulk approval actions
- Approval templates and workflows
- Approval analytics and reporting
- Email notifications
- Approval delegation

---

## üìù Implementation Notes

### Entity Type Mapping:

- `site_diary` ‚Üí Site Diaries
- `form` ‚Üí Forms
- `entries` ‚Üí Form Entries
- `tasks` ‚Üí Tasks

### Reusable UI Patterns:

- Status badges with consistent color coding
- Entity type icons (Book, FileText, List, CheckSquare)
- User avatars and names
- Date formatting utilities
- Action button groups

### Security Considerations:

- Verify user permissions for each approval action
- Validate entity access before showing approval details (read-only for approvers)
- Project admins have visibility over all project approvals
- Audit trail for all approval actions
- Rate limiting for approval actions
- Support flexible status transitions (declined ‚Üí resubmitted, approved ‚Üí revision requested)

---

## üé® Design System Integration

### Colors & Status Mapping:

- **Draft:** `bg-gray-500`
- **Submitted:** `bg-blue-500`
- **Approved:** `bg-green-500`
- **Declined:** `bg-red-500`
- **Revision Requested:** `bg-yellow-500`

### Icons:

- Approvals: `CheckCircle2`
- Site Diary: `Book`
- Forms: `FileText`
- Entries: `List`
- Tasks: `CheckSquare`

### Component Consistency:

- Follow existing button variants and sizes
- Use established spacing patterns
- Maintain consistent typography hierarchy
- Reuse existing card and sheet components

---

## üöÄ Implementation Priority Order

### Phase A: Site Diaries MVP (First Implementation)

1. ‚úÖ **Database Updates** (1.1, 1.2, 1.3) - COMPLETE
2. ‚úÖ **Generate Types** (2.1) - Run `npm run types:db` - COMPLETE
3. ‚úÖ **Site Diary API Extensions** (2.2, 2.3 for site_diary only) - COMPLETE
4. üöß **Core UI Components** (3.1, 3.2 for site diaries) - IN PROGRESS
   - ‚úÖ ApprovalsList component with filtering and search
   - ‚úÖ ApprovalCard component with status badges and entity icons
   - ‚úÖ Custom hooks (usePendingApprovals, useMyApprovalRequests)
   - ‚úÖ ApprovalDetailDrawer component
     - ‚úÖ ApprovalActions component
     - ‚úÖ ApprovalComments component
5. ‚úÖ **Navigation & Routing** (4.1, 4.2) - Main page complete, detail route pending
6. ‚è≥ **Testing & Validation** (8.1, 8.2 for site diaries)

### Phase B: Expand to Other Entities

- Repeat API and UI development for Forms, Entries, then Tasks
- Follow same patterns established in Phase A

### Phase C: Advanced Features

- Performance optimizations (9.1, 9.2)
- Future enhancements (10.1, 10.2)

---

## üìã Key Design Decisions Based on Requirements

### Approval Workflow Logic:

- **Single Approver:** One approval = approved status
- **Multiple Approvers:** ALL approvers must approve for approved status
- **Priority Logic:** Any decline/revision request overrides approvals
- **Status Flexibility:** No restrictions on status transitions

### UI Structure:

- **Two-Tab Interface:** "Pending Approvals" + "My Requests"
- **Filtering Options:** Entity type, requester name, date ranges
- **No Project Filter:** User sees current project context only
- **Desktop-First:** Responsive design using flexbox

### Access Control:

- **Approvers:** Read-only access to entities they're approving
- **Project Admins:** Full visibility of all project approvals
- **Comments Visibility:** Requester + Approvers + Project Admins

### Future-Ready Design:

- Database schema can support notifications when implemented later
- Component architecture allows easy expansion to new entity types
